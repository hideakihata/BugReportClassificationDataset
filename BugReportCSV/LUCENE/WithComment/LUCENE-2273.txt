FieldCacheImpl s getCacheEntries is buggy as it uses WeakHashMap incorrectly and leads to ConcurrentModExceptions
The way how WeakHashMap works internally leads to the fact that it is not allowed to iterate over a WHM.keySet and then get the value. As each get operation inspects the ReferenceQueue of the weak keys they may suddenly disappear. If you use the entrySet iterator you get key and value and no need to call get contains ... that inspects the ReferenceQueue. Can we add lucene.internal to this API as well Or lucene.experimental Its already marked as experimental in the interface Here the fix will commit this soon. Committed revision 912330 I added one more null check on the weak key of the cache in rev 912331
