CMS fails to cleanly stop threads
When you close IW it waits for or aborts and then waits for all running merges. However it s wait criteria is wrong Ð it waits for the threads to be done w their merges not for the threads to actually die. CMS already has a sync method to wait for running threads which we can call from CMS.close. However it has a thread hazard because a MergeThread removes itself from mergeThreads before it actually exits. So sync is able to return even while a merge thread is still running. This was uncovered by LUCENE-2819 on the test case TestCustomScoreQuery.testCustomExternalQuery though I expect other test cases would show it. Patch. I changed CMS.sync to .join to any still-alive threads and changed MergeThread to not remove itself from mergeThreads but rather updateMergeThread to prune any dead threads. This is causing deadlock in some tests Take 2 Bulk close for 3.1
