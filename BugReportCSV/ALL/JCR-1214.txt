DocId.UUIDDocId should not have a string attr uuid
After JCR-1213 will be solved lots of DocId.UUIDDocId can be cached and not being cleaned after every gc . The number of cached UUIDDocId can grow very large depending on the size of the repository. Therefor instead of storing the private String uuid we can make it more memory efficient by storing 2 long s the lsb and msb of the uuid. Storing 1.000.000 of parent UUIDDocId might differ about 100Mb of memory. I even did test by removing the entire uuid string and not use msb or lsb because when everything works properly with references to index reader segments See JCR-1213 the uuid is never needed again in UUIDDocId getDocumentNumber IndexReader reader throws IOException we could set uuid null just before the return. It works perfectly well because when an index reader is recreated the CachingIndexReader will be recreated hence DocId parents will be recreated. So IMO I think we might be able to remove the uuid entirely when the docNumber is found in DocId.UUIDDocId obviously after JCR-1213 WDOT For simplicity I would rather use an instance of UUID instead of two longs. Ard wrote I think we might be able to remove the uuid entirely ... no that s not possible. the critical use case is index segment merges. consider the following index segments i1 i2 i3 now let s assume i1 contains a UUIDDocId which refers to a node in i2. then i2 and i3 are merged and replaced by i4 i1 i4 on next access to the above mentioned UUIDDocId it will realize that the reader that was used to get the document number is gone and as a consequence will be forced to get the document number again and adjust the reader reference to i4. hope that makes sense... For simplicity I would rather use an instance of UUID instead of two longs. Yes that is easier hope that makes sense... Yes it totally does goog explanation also and I actually saw this exact behavior already occuring in my test setups. I was having a little misunderstanding about the fact that logically though parents can be found in a different index segment and this index might be recreated while the index holding the UUIDDocId to this parent. I also have noticed while working on JCR-1213 I found that it only worked when all indexes did not change while it went wrong when I was having changing merging indexes. Exactly the way you describe. I am about to get all things sorted out regarding the combined index reader which contains cachingmulti index readers which contain in their turn lucene indexes. Might be an idea to picture this a little for documentation or is there already something like it I have only one thing I am still not yet sure about which you might know from the top of your head it is regarding JCR-1213 and this one I have the idea that the CombinedIndexReader when doing a search in a workspace normally contains 2 index reader the one for workspace and a parent index containing repository index info like node types isn t right Now I need to find out wether when looking up a parent if it is ever possible that a parent of a node can be found in the parent index hope it is clear waht i mean . I think it is not and this might be quite important for me to implement JCR-1213 by caching regarding references to an index segment. One extra thing regarding JCR-1213 I also have to test that when merging like you describe above happens the cached docNumber for an index that did not change might have a different position in the MultiIndexReader after segment merging....ouchhhhh. Anyway it makes it all a little more complex but will find these kind of things during implementing this issue and 1213. Might be an idea to picture this a little for documentation or is there already something like it no I m afraid there isn t but it s definitively a good idea ... if it is ever possible that a parent of a node can be found in the parent index. that s not possible. the parent index contains the nodes under jcr system including the jcr system node . the opposite is possible though just for one node the mentioned jcr system node. this one will have a UUIDDocId which references the root node of the workspace. no I m afraid there isn t but it s definitively a good idea - Perhaps I can make one though i am terrible at making pics because I want to have it here at the office as well for a common understanding of the jackrabbit indexing ... if it is ever possible that a parent of a node can be found in the parent index. that s not possible. the parent index contains the nodes under jcr system including the jcr system node . the opposite is possible though just for one node the mentioned jcr system node. this one will have a UUIDDocId which references the root node of the workspace. That is good news and makes it a little easier. Am thinking about a two step check where first a reference to the entire MultiIndexReader is checked. IF check reference to the entire MultiIndexReader instance is positive return cached results. ELSE IF check the index reader segment instance the parent docnumber was in if instance present recompute docNumber with respect to the new offsets in MultiIndexReader and return almost cached result. ELSE recompute docNumber by search in MultiIndexReader the uncached case I will try to implement it during the weekend because the next days I am really occupied. Will share my findings and tests and performance issues hopefully on sunday.I think this discussion rather belongs to JCR-1213. I ll copy over your last comment and follow up there.Replaced the uuid String with a UUID instance. svn revision 596274. For simplicity I would rather use an instance of UUID instead of two longs. By the way I think the overhead of a UUID instance 12-16 bytes for an Object seems to me redundant if only storing 2 longs is enough. My intention was to reduce memory consumption for the string uuid 120 bytes to two long s. Ofcourse a UUID instance is still smaller than the original 120 bytes but still uses redundant memory though I admit probably UUID instances are small enough - Thx for solving the issue You are right. Let s get rid of those remaining bytes as well. Replaced UUID instance with two longs. svn revision 596286 - thanks again by the way after filing the jira issue ofcourse I did not intend to not solve the issue. I thought trying JCR-1213 in combination with this one to not create an extra patch because this one is such a basic one Anyway thanks for solving it and I ll try to get the patch with respect to 1213 somewhere this week weekend.
