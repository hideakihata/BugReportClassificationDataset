Unable to login with two different Credentials to same workspace in one Transaction
I m using the Jackrabbit 1.2.1 JCA adapter and trying to access in a SessionBean-Method with Container Transaction a Workspace with 2 different Credentials. The Method takes about 400ms to finish but no commit on TransactionContextr occurs Debugging .. only the prepare was called 2 times . The Container hangs on the PostInvoke Method about 5 seconds and then i get a javax.transaction.xa.XAException with the Warn Message Transaction rolled back because timeout expired The code .. Context ctx new InitialContext Repository repository Repository ctx.lookup java comp env jackrabbit Credentials credentials new SimpleCredentials user1 password1 .toCharArray Credentials credentials2 new SimpleCredentials user2 password2 .toCharArray Session session1 repository.login credentials default Session session2 repository.login credentials2 default Session1 adds a node to the workspace .. and with the session2 i do nothing except the login If i make no second login the Method works fine.The stacktrace of the exceptionI have put some info logs into the XASessionImpl TransactionContext and XAWorkspace to find out where the problem is. Now i found the problem .. Below are the the Info logs .. The 1 log entry explains the log format .. 2007-03-07 12 44 00 212 INFO - On Class XASessionImpl In Method start for Instance toString org.apache.jackrabbit.core.XASessionImpl 53265326 2007-03-07 12 44 00 212 INFO - XASessionImpl associate for org.apache.jackrabbit.core.XASessionImpl 53265326 given TransactionContext org.apache.jackrabbit.core.TransactionContext 50a950a9 2007-03-07 12 44 00 227 INFO - XASessionImpl start for org.apache.jackrabbit.core.XASessionImpl 111c111c 2007-03-07 12 44 00 227 INFO - XASessionImpl associate for org.apache.jackrabbit.core.XASessionImpl 111c111c given TransactionContext org.apache.jackrabbit.core.TransactionContext a460a46 2007-03-07 12 44 01 650 INFO - XASessionImpl end for org.apache.jackrabbit.core.XASessionImpl 111c111c 2007-03-07 12 44 01 650 INFO - XASessionImpl associate for org.apache.jackrabbit.core.XASessionImpl 111c111c given TransactionContext null 2007-03-07 12 44 01 650 INFO - XASessionImpl end for org.apache.jackrabbit.core.XASessionImpl 53265326 2007-03-07 12 44 01 650 INFO - XASessionImpl associate for org.apache.jackrabbit.core.XASessionImpl 53265326 given TransactionContext null 2007-03-07 12 44 01 650 INFO - XASessionImpl prepare for org.apache.jackrabbit.core.XASessionImpl 111c111c 2007-03-07 12 44 01 650 INFO - XASessionImpl TransactionContext.prepare start 2007-03-07 12 44 01 650 INFO - TransactionContext prepare prepareResource start on org.apache.jackrabbit.core.TransactionContext a460a46 2007-03-07 12 44 01 650 INFO - Resource is org.apache.jackrabbit.core.XAWorkspace 1 1f641f64 2007-03-07 12 44 01 650 INFO - XAWorkspace prepare in XAResourceBegin lockAcquire start 2007-03-07 12 44 01 650 INFO - XAWorkspace prepare in XAResourceBegin lockAcquire end 2007-03-07 12 44 01 650 INFO - TransactionContext prepare prepareResource end on org.apache.jackrabbit.core.TransactionContext a460a46 2007-03-07 12 44 01 650 INFO - TransactionContext prepare prepareResource start on org.apache.jackrabbit.core.TransactionContext a460a46 2007-03-07 12 44 01 650 INFO - Resource is org.apache.jackrabbit.core.state.XAItemStateManager 14e614e6 2007-03-07 12 44 01 650 INFO - TransactionContext prepare prepareResource end on org.apache.jackrabbit.core.TransactionContext a460a46 2007-03-07 12 44 01 650 INFO - TransactionContext prepare prepareResource start on org.apache.jackrabbit.core.TransactionContext a460a46 2007-03-07 12 44 01 650 INFO - Resource is org.apache.jackrabbit.core.lock.XALockManager 1f561f56 2007-03-07 12 44 01 650 INFO - TransactionContext prepare prepareResource end on org.apache.jackrabbit.core.TransactionContext a460a46 2007-03-07 12 44 01 650 INFO - TransactionContext prepare prepareResource start on org.apache.jackrabbit.core.TransactionContext a460a46 2007-03-07 12 44 01 650 INFO - Resource is org.apache.jackrabbit.core.version.XAVersionManager 1bee1bee 2007-03-07 12 44 01 650 INFO - TransactionContext prepare prepareResource end on org.apache.jackrabbit.core.TransactionContext a460a46 2007-03-07 12 44 01 650 INFO - TransactionContext prepare prepareResource start on org.apache.jackrabbit.core.TransactionContext a460a46 2007-03-07 12 44 01 650 INFO - Resource is org.apache.jackrabbit.core.XAWorkspace 2 1f681f68 2007-03-07 12 44 01 650 INFO - TransactionContext prepare prepareResource end on org.apache.jackrabbit.core.TransactionContext a460a46 2007-03-07 12 44 01 650 INFO - TransactionContext prepare afterOperation start on org.apache.jackrabbit.core.TransactionContext a460a46 2007-03-07 12 44 01 650 INFO - TransactionContext prepare afterOperation end on org.apache.jackrabbit.core.TransactionContext a460a46 2007-03-07 12 44 01 650 INFO - TransactionContext prepare Method end onorg.apache.jackrabbit.core.TransactionContext a460a46 2007-03-07 12 44 01 650 INFO - XASessionImpl TransactionContext.prepare end 2007-03-07 12 44 01 650 INFO - XASessionImpl return 0 2007-03-07 12 44 01 650 INFO - XASessionImpl prepare for org.apache.jackrabbit.core.XASessionImpl 53265326 2007-03-07 12 44 01 650 INFO - XASessionImpl TransactionContext.prepare start 2007-03-07 12 44 01 650 INFO - TransactionContext prepare beforeOperation start on org.apache.jackrabbit.core.TransactionContext 50a950a9 2007-03-07 12 44 01 650 INFO - TransactionContext prepare beforeOperation end on org.apache.jackrabbit.core.TransactionContext 50a950a9 2007-03-07 12 44 01 650 INFO - TransactionContext prepare prepareResource start on org.apache.jackrabbit.core.TransactionContext 50a950a9 2007-03-07 12 44 01 650 INFO - Resource is org.apache.jackrabbit.core.XAWorkspace 1 618a618a And here is the Problem .. 2007-03-07 12 44 01 650 INFO - XAWorkspace prepare in XAResourceBegin lockAcquire start Between these 2 Methods 5 seconds elapse - the specified Timeout 2007-03-07 12 44 06 654 INFO - XAWorkspace prepare in XAResourceBegin lockAcquire end 2007-03-07 12 44 06 654 INFO - TransactionContext prepare prepareResource end on org.apache.jackrabbit.core.TransactionContext 50a950a9 2007-03-07 12 44 06 654 INFO - TransactionContext prepare prepareResource start on org.apache.jackrabbit.core.TransactionContext 50a950a9 2007-03-07 12 44 06 654 INFO - Resource is org.apache.jackrabbit.core.state.XAItemStateManager 56ec56ec 2007-03-07 12 44 06 654 WARN - Transaction rolled back because timeout expired. 2007-03-07 12 44 06 654 INFO - TransactionContext prepare prepareResource end on org.apache.jackrabbit.core.TransactionContext 50a950a9 2007-03-07 12 44 06 654 INFO - TransactionContext prepare prepareResource start on org.apache.jackrabbit.core.TransactionContext 50a950a9 2007-03-07 12 44 06 654 INFO - Resource is org.apache.jackrabbit.core.lock.XALockManager 617c617c 2007-03-07 12 44 06 654 INFO - TransactionContext prepare prepareResource end on org.apache.jackrabbit.core.TransactionContext 50a950a9 2007-03-07 12 44 06 654 INFO - TransactionContext prepare prepareResource start on org.apache.jackrabbit.core.TransactionContext 50a950a9 2007-03-07 12 44 06 654 INFO - Resource is org.apache.jackrabbit.core.version.XAVersionManager 5e145e14 2007-03-07 12 44 06 654 INFO - TransactionContext prepare prepareResource end on org.apache.jackrabbit.core.TransactionContext 50a950a9 2007-03-07 12 44 06 654 INFO - TransactionContext prepare prepareResource start on org.apache.jackrabbit.core.TransactionContext 50a950a9 2007-03-07 12 44 06 654 INFO - Resource is org.apache.jackrabbit.core.XAWorkspace 2 618e618e 2007-03-07 12 44 06 654 INFO - TransactionContext prepare prepareResource end on org.apache.jackrabbit.core.TransactionContext 50a950a9 2007-03-07 12 44 06 654 INFO - TransactionContext prepare afterOperation start on org.apache.jackrabbit.core.TransactionContext 50a950a9 2007-03-07 12 44 06 654 INFO - TransactionContext prepare afterOperation end on org.apache.jackrabbit.core.TransactionContext 50a950a9 2007-03-07 12 44 06 654 INFO - TransactionContext prepare Method end onorg.apache.jackrabbit.core.TransactionContext 50a950a9 2007-03-07 12 44 06 654 INFO - XASessionImpl TransactionContext.prepare end 2007-03-07 12 44 06 654 INFO - XASessionImpl return 0 2007-03-07 12 44 06 670 INFO - XASessionImpl commit for org.apache.jackrabbit.core.XASessionImpl 53265326 2007-03-07 12 44 07 030 INFO - XASessionImpl commit for org.apache.jackrabbit.core.XASessionImpl 111c111c The TransactionContextet keep in prepare state because the WorkspaceInfo acquires the Lock and will it realese on commit but a Deadlock occurs. I hope i have explained it to understand otherwise i will explain it to the day guys in german - thanks claus As explained in the comment before the first XASession tolds the TransactionContext to prepare all its XA Resources. So one of this Resources is the InternalXAResource of the XAWorkspace getXAResourceBegin . This Resource creates a lock on the WorkspaceInfo Object in the prepare Method. So a lock has been acquired. The second XASession has also its XAResources and also the InternalXAResource of the XAWorkspace. So if the second Session tries to prepare the InternalXAResource a lock is already on the WorkspaceInfo until a Rollback occurs. I have fixed this problem. I have a boolean value in the WorkspaceInfo that holds the information if a lock was previous has been acquired. because the Mutex has no Method to get the information if a lock has been acquired before. This fix works fine for me. Are there any thoughts for this fix strategy The patch to solve the Problem.If I understand you correctly prepare on the XA transaction will in turn invoke prepare on both XASessions. The second one being invoked will block for 5 seconds because the WorkspaceInfo has already been locked by the first one. Eventually the second internal transaction will be rolled back and the whole transaction fails. Your patch will eliminate this double-locking but in turn may lead to 2 or more XASessions concurrently updating shared state which might result in corruption see JCR-335 for more details. In order to fix this problem the individual updates on prepare should probably be more thoroughly inspected to detect clashes and if none occurs allow them. This would work for your usecase at least since one of your sessions makes no update at all.hi dominique yes you have understood me i have read the JCR-335 and you are right. but let see this szenario you must open a Admin Session next to a normal User Session so you have 2 XASession in one Transaction and this wil not work now. you are right the second session makes no updates but maybe it will. i think we must look that we use the same TransactionContext as shareable like a shareable DataSource in EJBContainer. so we can check it in the XAResources before we make a exclusive lock. The same behaviour we have in EJBContainer with DataSources. If you have a Transaction with 2 Entity Beans and a IsolationLevel like serializeable you must also look to get a reference from the the same DataSource Connection to prevent a lock on db from the first ejb.I completely agree that your scenario is a viable one. There is just one small problem from your logging output I deduce that there are actually two active TransactionContext instances one named TransactionContext 50a950a9 the other one TransactionContext a460a46 package names omitted for brevity . This implies that their respective XIDs are different and this makes it hardly detectable for JR s internal transaction manager to relate them. As far as I understand the Admin session is created by your custom AccessManager to check whether the user represented by your normal User session is actually allowed to do what he tries to. When starting a repository that will itself register in the by JNDI namespace or in the RMI registry a custom AccessManager will be able get a reference back to the actual repository being queried. In the JCA case this is probably something that is missing because getting an Admin session through JCA - and thereby creating a second transaction - looks like overkill to me.You are absolutly right the Problem are the different Xid s. I have tested to store the GlobalTransactionId GTI from the Xid Object instead the whole Xid Object. The GTI is the same The only Problem is that i do not get the rigth flag i get the TMNOFLAGS so a new TransactionContextObject will be created. I am not a expert wirth XA-flags maybe you have any ideas .. clausI have changed the code in the XASessionImpl to store the TransactionContext with the GlobalTransactionId as Key in the txGlobal Map instead the whole Xid Object to get only one TransactionContext Object during the whole XATransaction This works fine for me and i think this is the right way. I have traced the entire XA Transaction. As you will see the problem with the lock in the WorkspaceInfo Object still occurs without my Patch The Log 2007-03-13 13 43 52 043 INFO - XASessionImpl start for org.apache.jackrabbit.core.XASessionImpl 6bf66bf6 with Xid XID formatId 57415344 gtrid length 39 bqual length 28 data 0000000000000006000000488d8c7348c471a220c9a781d64d29d7e7edb72842736572766572318d8c7348c471a220c9a781d64d29d7e7edb728420000004842354235 2007-03-13 13 43 52 059 INFO - XASessionImpl start flag is TMNOFLAGS 2007-03-13 13 43 52 090 INFO - XASessionImpl found Transaction null 2007-03-13 13 43 52 090 INFO - XASessionImpl associate for org.apache.jackrabbit.core.XASessionImpl 6bf66bf6 with Context org.apache.jackrabbit.core.TransactionContext 11ec11ec 2007-03-13 13 43 52 106 INFO - XASessionImpl start for org.apache.jackrabbit.core.XASessionImpl 30ac30ac with Xid XID formatId 57415344 gtrid length 39 bqual length 28 data 0000000000000006000000488d8c7348c471a220c9a781d64d29d7e7edb72842736572766572318d8c7348c471a220c9a781d64d29d7e7edb728420000004877407740 2007-03-13 13 43 52 106 INFO - XASessionImpl start flag is TMNOFLAGS 2007-03-13 13 43 52 106 INFO - XASessionImpl found Transaction org.apache.jackrabbit.core.TransactionContext 11ec11ec 2007-03-13 13 43 52 106 INFO - XASessionImpl associate for org.apache.jackrabbit.core.XASessionImpl 30ac30ac with Context org.apache.jackrabbit.core.TransactionContext 11ec11ec 2007-03-13 13 43 52 621 INFO - at.gv.tirol.common.jcr.security.AccessManager.isGranted MESSAGE No AccessNodeList check for Node 2d3d89030a0c889a36853685d9d417b1.pdf http www.jcp.org jcr 1.0 content 2007-03-13 13 43 52 621 INFO - at.gv.tirol.common.jcr.security.AccessManager.isGranted MESSAGE No AccessNodeList check for Node 2d3d89030a0c889a36853685d9d417b1.pdf 2007-03-13 13 43 52 621 INFO - at.gv.tirol.common.jcr.security.AccessManager.isGranted MESSAGE No AccessNodeList check for Node 2d3d89030a0c889a36853685d9d417b1.pdf http www.jcp.org jcr 1.0 content 2007-03-13 13 43 52 653 INFO - at.gv.tirol.common.jcr.security.AccessManager.isGranted MESSAGE No AccessNodeList check for Node 2d3d89030a0c889a36853685d9d417b1.pdf 2007-03-13 13 43 52 653 INFO - at.gv.tirol.common.jcr.security.AccessManager.isGranted MESSAGE Access to Root Node 2007-03-13 13 43 52 684 INFO - XASessionImpl end for org.apache.jackrabbit.core.XASessionImpl 30ac30ac with Xid XID formatId 57415344 gtrid length 39 bqual length 28 data 0000000000000006000000488d8c7348c471a220c9a781d64d29d7e7edb72842736572766572318d8c7348c471a220c9a781d64d29d7e7edb728420000004877407740 2007-03-13 13 43 52 684 INFO - XASessionImpl associate for org.apache.jackrabbit.core.XASessionImpl 30ac30ac with Context null 2007-03-13 13 43 52 684 INFO - XASessionImpl end for org.apache.jackrabbit.core.XASessionImpl 6bf66bf6 with Xid XID formatId 57415344 gtrid length 39 bqual length 28 data 0000000000000006000000488d8c7348c471a220c9a781d64d29d7e7edb72842736572766572318d8c7348c471a220c9a781d64d29d7e7edb728420000004842354235 2007-03-13 13 43 52 684 INFO - XASessionImpl associate for org.apache.jackrabbit.core.XASessionImpl 6bf66bf6 with Context null 2007-03-13 13 43 52 684 INFO - XASessionImpl prepare for org.apache.jackrabbit.core.XASessionImpl 30ac30ac with Xid XID formatId 57415344 gtrid length 39 bqual length 28 data 0000000000000006000000488d8c7348c471a220c9a781d64d29d7e7edb72842736572766572318d8c7348c471a220c9a781d64d29d7e7edb728420000004877407740 2007-03-13 13 43 52 684 INFO - XASessionImpl TransactionContext.prepare start 2007-03-13 13 43 52 684 INFO - TransactionContext prepare beforeOperation start on org.apache.jackrabbit.core.TransactionContext 11ec11ec 2007-03-13 13 43 52 684 INFO - TransactionContext prepare beforeOperation end on org.apache.jackrabbit.core.TransactionContext 11ec11ec 2007-03-13 13 43 52 684 INFO - TransactionContext prepare prepareResource start on org.apache.jackrabbit.core.TransactionContext 11ec11ec 2007-03-13 13 43 52 684 INFO - Resource is org.apache.jackrabbit.core.XAWorkspace 1 74817481 XAWorkspace prepare in XAResourceBegin lockAcquire start 2007-03-13 13 43 52 684 INFO - WorkspaceInfo lockAcquire lock is already false XAWorkspace prepare in XAResourceBegin lockAcquire end 2007-03-13 13 43 52 684 INFO - TransactionContext prepare prepareResource end on org.apache.jackrabbit.core.TransactionContext 11ec11ec 2007-03-13 13 43 52 684 INFO - TransactionContext prepare prepareResource start on org.apache.jackrabbit.core.TransactionContext 11ec11ec 2007-03-13 13 43 52 684 INFO - Resource is org.apache.jackrabbit.core.state.XAItemStateManager 2ad32ad3 2007-03-13 13 43 52 715 INFO - TransactionContext prepare prepareResource end on org.apache.jackrabbit.core.TransactionContext 11ec11ec 2007-03-13 13 43 52 715 INFO - TransactionContext prepare prepareResource start on org.apache.jackrabbit.core.TransactionContext 11ec11ec 2007-03-13 13 43 52 715 INFO - Resource is org.apache.jackrabbit.core.lock.XALockManager 176a176a 2007-03-13 13 43 52 715 INFO - TransactionContext prepare prepareResource end on org.apache.jackrabbit.core.TransactionContext 11ec11ec 2007-03-13 13 43 52 715 INFO - TransactionContext prepare prepareResource start on org.apache.jackrabbit.core.TransactionContext 11ec11ec 2007-03-13 13 43 52 715 INFO - Resource is org.apache.jackrabbit.core.version.XAVersionManager 42bf42bf 2007-03-13 13 43 52 715 INFO - TransactionContext prepare prepareResource end on org.apache.jackrabbit.core.TransactionContext 11ec11ec 2007-03-13 13 43 52 715 INFO - TransactionContext prepare prepareResource start on org.apache.jackrabbit.core.TransactionContext 11ec11ec 2007-03-13 13 43 52 715 INFO - Resource is org.apache.jackrabbit.core.XAWorkspace 2 45f945f9 2007-03-13 13 43 52 715 INFO - TransactionContext prepare prepareResource end on org.apache.jackrabbit.core.TransactionContext 11ec11ec 2007-03-13 13 43 52 715 INFO - TransactionContext prepare afterOperation start on org.apache.jackrabbit.core.TransactionContext 11ec11ec 2007-03-13 13 43 52 715 INFO - TransactionContext prepare afterOperation end on org.apache.jackrabbit.core.TransactionContext 11ec11ec 2007-03-13 13 43 52 715 INFO - TransactionContext prepare Method end onorg.apache.jackrabbit.core.TransactionContext 11ec11ec 2007-03-13 13 43 52 715 INFO - XASessionImpl TransactionContext.prepare end 2007-03-13 13 43 52 715 INFO - XASessionImpl return 0 2007-03-13 13 43 52 715 INFO - XASessionImpl prepare for org.apache.jackrabbit.core.XASessionImpl 6bf66bf6 with Xid XID formatId 57415344 gtrid length 39 bqual length 28 data 0000000000000006000000488d8c7348c471a220c9a781d64d29d7e7edb72842736572766572318d8c7348c471a220c9a781d64d29d7e7edb728420000004842354235 2007-03-13 13 43 52 715 INFO - XASessionImpl TransactionContext.prepare start 2007-03-13 13 43 52 715 INFO - TransactionContext prepare beforeOperation start on org.apache.jackrabbit.core.TransactionContext 11ec11ec 2007-03-13 13 43 52 715 INFO - TransactionContext prepare beforeOperation end on org.apache.jackrabbit.core.TransactionContext 11ec11ec 2007-03-13 13 43 52 715 INFO - TransactionContext prepare prepareResource start on org.apache.jackrabbit.core.TransactionContext 11ec11ec 2007-03-13 13 43 52 715 INFO - Resource is org.apache.jackrabbit.core.XAWorkspace 1 74817481 A Lock will be aquired but if we do not check if a lock is already on it a Deadlock will occur XAWorkspace prepare in XAResourceBegin lockAcquire start 2007-03-13 13 43 52 715 INFO - WorkspaceInfo lockAcquire lock is already true XAWorkspace prepare in XAResourceBegin lockAcquire end 2007-03-13 13 43 52 715 INFO - TransactionContext prepare prepareResource end on org.apache.jackrabbit.core.TransactionContext 11ec11ec 2007-03-13 13 43 52 715 INFO - TransactionContext prepare prepareResource start on org.apache.jackrabbit.core.TransactionContext 11ec11ec 2007-03-13 13 43 52 715 INFO - Resource is org.apache.jackrabbit.core.state.XAItemStateManager 2ad32ad3 2007-03-13 13 43 52 715 INFO - TransactionContext prepare prepareResource end on org.apache.jackrabbit.core.TransactionContext 11ec11ec 2007-03-13 13 43 52 715 INFO - TransactionContext prepare prepareResource start on org.apache.jackrabbit.core.TransactionContext 11ec11ec 2007-03-13 13 43 52 715 INFO - Resource is org.apache.jackrabbit.core.lock.XALockManager 176a176a 2007-03-13 13 43 52 715 INFO - TransactionContext prepare prepareResource end on org.apache.jackrabbit.core.TransactionContext 11ec11ec 2007-03-13 13 43 52 715 INFO - TransactionContext prepare prepareResource start on org.apache.jackrabbit.core.TransactionContext 11ec11ec 2007-03-13 13 43 52 715 INFO - Resource is org.apache.jackrabbit.core.version.XAVersionManager 42bf42bf 2007-03-13 13 43 52 715 INFO - TransactionContext prepare prepareResource end on org.apache.jackrabbit.core.TransactionContext 11ec11ec 2007-03-13 13 43 52 715 INFO - TransactionContext prepare prepareResource start on org.apache.jackrabbit.core.TransactionContext 11ec11ec 2007-03-13 13 43 52 715 INFO - Resource is org.apache.jackrabbit.core.XAWorkspace 2 45f945f9 2007-03-13 13 43 52 715 INFO - TransactionContext prepare prepareResource end on org.apache.jackrabbit.core.TransactionContext 11ec11ec 2007-03-13 13 43 52 715 INFO - TransactionContext prepare afterOperation start on org.apache.jackrabbit.core.TransactionContext 11ec11ec 2007-03-13 13 43 52 715 INFO - TransactionContext prepare afterOperation end on org.apache.jackrabbit.core.TransactionContext 11ec11ec 2007-03-13 13 43 52 715 INFO - TransactionContext prepare Method end onorg.apache.jackrabbit.core.TransactionContext 11ec11ec 2007-03-13 13 43 52 715 INFO - XASessionImpl TransactionContext.prepare end 2007-03-13 13 43 52 715 INFO - XASessionImpl return 0 2007-03-13 13 43 52 731 INFO - XASessionImpl commit for org.apache.jackrabbit.core.XASessionImpl 6bf66bf6 with Xid XID formatId 57415344 gtrid length 39 bqual length 28 data 0000000000000006000000488d8c7348c471a220c9a781d64d29d7e7edb72842736572766572318d8c7348c471a220c9a781d64d29d7e7edb728420000004842354235 2007-03-13 13 43 52 731 INFO - XASessionImpl commit for org.apache.jackrabbit.core.XASessionImpl 30ac30ac with Xid XID formatId 57415344 gtrid length 39 bqual length 28 data 0000000000000006000000488d8c7348c471a220c9a781d64d29d7e7edb72842736572766572318d8c7348c471a220c9a781d64d29d7e7edb728420000004877407740 The next Problem is now that the commit Method from the first Session will delete the TransactionContext from the Cache and this is very bad because the second Session will not find the TransactionContext in the Cache in its commit Method so a XAException XAException.XAER NOTA will occur. I hope this stack will help to understand the problem.Thank you for the trace information which really makes it easy to follow what happens. As I stated in my last post I still consider the information your access manager has at hand - or rather the lack of - to be the real problem in your situation. Your access manager shouldn t resort to logging in via JCA connection factory and thereby starting another transaction but should rather be somehow given access to the repository itself or better still a system session to get ACL information. Honestly I think that simply ignoring the branch id when identifying transactions will most definitely lead to problems in other situations and or with other application servers. According to the DTP XA specification 1 section 7.2 Resource Manager Requirements   An RM can use the bqual component of the XID structure to let different branches of the same global transaction prepare to commit at   different times and to avoid deadlock see Section 4.2 on page 19 . In other words Jackrabbit might detect this situation and rearrange the order of operations but there still remains the non-trivial task of identifying potential conflicts. 1 Distributed Transaction Processing The XA specification http www.opengroup.org onlinepubs 009680699 I agree with you that is it not good to acquire a second session through JCA in the AccessManager. I have already changed my code without a session in my accessmanager a few days before and now i have not anymore problems with the xa transaction. Although i have tested the behaviour with two sessions in one transaction because i think the current implemention can not work with two sessions in one transaction concerning more factors. The first is that the WorkspaceInfo acquires a exclusiv lock. As you can see on the above trace that i have only one transactioncontext object involved in the transaction but this solves not the problem because every session gets prepared and so the workspaceinfo object will be prepared two times The second thing is the XID in combination with the txGlobal Map. I have read the specification and as you say we can not ignore the branch id. As i understand the branchid it is used to differentiate the xaresources in one distributed transaction. In our use case the 2 xasessionimpl s are these branches and so they can not be the same. So you will never find a TransactionContext Object with the XID as Key in the txGlobal Map in a global Transaction. I have found a good documentation about the use of branches http download-west.oracle.com docs cd B10501 01 java.920 a96654 xadistra.htm As they write When you use XA functionality the transaction manager uses XA resource instances to prepare and coordinate each transaction branch and then to commit or roll back all transaction branches appropriately or The prepare step is the first step of a two-phase COMMIT operation. The transaction manager will issue a prepare to each XA resource instance. Once the transaction manager sees that the operations of each transaction branch have prepared successfully it will issue a COMMIT to each XA resource instance to commit all the changes The XASessionImpl implements the XAResource so it is a branch or not In the specification under 4.2 is written The only requirement is that both gtrid and bqual taken together must be globally unique. So maybe i am wrong otherwise please tell me how you see that thingsAs you correctly identified if there are two sessions or branches involved in the same transaction let s say TX1B1 and TX2B2 the sequence of calls TX1B1.prepare TX1B2.prepare TX1B1.commit TX1B2.commit willl timeout in the call to TX1B2.prepare. But fixing the problem is not simply a matter of replacing the exclusive lock obtained in TX1B1.prepare with a more concurrency-friendy one but one would have to eventually merge the changes in TX1B1 and TX2B2 and detect potential conflicts which is far more complicated and currently not implemented. In other words this bug is absolutely legitimate but in your situation one can work around it.Ok from that point i think we should identify the problems exclusiv locking finding transactioncontext in the global transaction map when should we delete the transactioncontext from the global map ... with more XAResources in a distributed Transaction and open some jira issues or maybe rename the current issue and define more informations. What do you think. I can add my patch to store XAResources with its GlobalTransactionId not the whole XID. I agree that the fist patch is not good - Sorry for introducing TX2B2 which should be TX1B2 of course. IMO it makes no sense at this point to somehow change the way XIDs are mapped to TransactionContexts because they represent changes made by one user. To illustrate my point let s assume the following situation TX1B1 User joe makes some change to the repository TX2B2 User fred makes some other change to the repository Currently committing transaction TX1 as a whole will lock for some time and eventually fail as we know. Changing the way XIDs are mapped would perform all operations as joe or fred whoever comes first because they are stored as attributes of the TransactionContext. You can not easily switch to a TransactionContext that remembers changes made by several users. Honestly I do appreciate your eagerness to have this problem fixed but again it is not a simple matter of changing the way XIDs are mapped to TransactionContexts or when to delete them that will make the whole thing work.I have not sayed that i have fixed the problem only with the fact of changing the mapping between xid s and TransactionContexts. I thought that the semantic of joining XAResources to Global Transaction is better then the one it is now. For me its clear that the process is not easy and maybe a long term but if you think its is not importand to identify the problems ok let it be. I have not sayed that i have fixed the problem only with the fact of changing the mapping between xid s and TransactionContexts. Sorry I just thought I wasn t clear enough in my previous posts about why changing the mapping between XIDs and TransactionContexts is not the main issue. I thought that the semantic of joining XAResources to Global Transaction is better then the one it is now. An XAResoruce in jackrabbit currently maps 1-1 to a XASessionImpl which represents the user or better the changes made by one user. Of course one could also map an XAResource to all changes made inside a global transaction including all branches but that still leaves the problem of integrating all changes made by all users in that transaction. For me its clear that the process is not easy and maybe a long term but if you think its is not importand to identify the problems ok let it be. Sorry for having made that impression. You re right there must be some semantics to let jackrabbit identify that two branches actually belong to the same transaction but again I still consider merging multiple updates made by different users to be the main issue. Marking this as Patch Available though I didn t review the long discussion closely enough to tell whether the attached patch was already cancelled. Can someone take a look Based on JCR-1334 it was possible to login but with this patch a other deadlock problem is fixed.I will resolve this issue regarding to the problem to be unable to login with more credentials in one global transaction. The problem discussed related to the merge problematic should be handled in a seperate jira issue. Applied patch in rev. 819491Adjust Fix Version. Would be great to have it in 1.6.1 Release ...Merged to the 1.6 branch in revision 897904. Will be included in 1.6.1.
